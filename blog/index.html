<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Blog</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .top-nav {
      margin-bottom: 2rem;
    }
    .top-nav a {
      text-decoration: none;
      color: #111;
      background: #eee;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: 0.2s;
    }
    .top-nav a:hover {
      background: #111;
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
<div><a class="top-nav" href="../index.html#notes">‚Üê Back</a></div>
    <div class="header-controls">
      <input type="text" id="search" placeholder="Browse articles...">
    </div>
  </header>

  <main id="posts-container"></main>

  <script>
// ==========================
// Theme toggle with persistence
// ==========================
const themeToggle = document.getElementById("theme-toggle");
const currentTheme = localStorage.getItem("theme");
if (currentTheme === "dark") document.body.classList.add("dark");

themeToggle?.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
});

// ==========================
// LocalStorage helpers
// ==========================
function savePosts(posts) {
  localStorage.setItem("posts", JSON.stringify(posts));
}
function loadSavedPosts() {
  return JSON.parse(localStorage.getItem("posts")) || null;
}
function saveUserClaps(claps) {
  localStorage.setItem("userClaps", JSON.stringify(claps));
}
function loadUserClaps() {
  return JSON.parse(localStorage.getItem("userClaps") || "{}");
}

// ==========================
// Load posts.json
// ==========================
async function loadPosts() {
  const res = await fetch("posts.json");
  const posts = await res.json();

  // merge with saved claps
  const saved = loadSavedPosts();
  if (saved) {
    posts.forEach((p) => {
      const match = saved.find(sp => sp.file === p.file);
      if (match && typeof match.claps === "number") {
        p.claps = match.claps;
      }
    });
  }

  displayPosts(posts);
  setupSearch(posts);
  savePosts(posts);
}

// ==========================
// Hero Section üî•
// ==========================
function renderHero(container) {
  const hero = document.createElement("section");
  hero.className = "hero";
  hero.innerHTML = `
    <div style="flex:1">
      <h2>Welcome to my Blog</h2>
      <br>
      <p class="muted">
        Join my mailing list and get notified when i post an article <br><br>
      <div class="tag"><a href="/index.html"><strong>subscribe</strong></a></div>
      </p>
    </div>
  `;
  container.appendChild(hero);
}

// ==========================
// Display posts (cards) üî•
// ==========================
function displayPosts(posts) {
  const container = document.getElementById("posts-container");
  if (!container) return;

  container.innerHTML = "";
  posts.sort((a, b) => new Date(b.date) - new Date(a.date));

  renderHero(container);

  posts.forEach(post => {
    const card = document.createElement("div");
    card.className = "post-card";

    card.innerHTML = `
      <div class="post-meta">
        <div class="avatar">${post.title[0] || "N"}</div>
        <div style="flex:1">
          <h3 class="title">
            <a href="post.html?file=${post.file}">${post.title}</a>
          </h3>
          <p class="muted" style="font-size:13px">${post.date} ‚Ä¢ ${post.readTime}</p>
        </div>
      </div>
      <div class="tags">${post.tags.map(t => `<span class="tag">${t}</span>`).join("")}</div>
      <p class="excerpt">${post.excerpt}</p>
      <div class="claps" data-id="${post.file}">
        üëè <span>${post.claps}</span>
      </div>
    `;

    container.appendChild(card);
  });
}

// ==========================
// Clap handler (syncs everywhere)
// ==========================
document.addEventListener("click", (e) => {
  if (e.target.closest(".claps")) {
    const el = e.target.closest(".claps");
    const id = el.getAttribute("data-id");
    
    let posts = loadSavedPosts();
    if (!posts) return;
    
    const post = posts.find(p => p.file === id);
    if (!post) return;
    
    let userClaps = loadUserClaps();
    let current = userClaps[id] || 0;
    if (current >= 50) {
      alert("Max claps reached for this post (50).");
      return;
    }
    
    // update counts
    post.claps++;
    userClaps[id] = current + 1;
    savePosts(posts);
    saveUserClaps(userClaps);
    
    // sync all clap counters on this page
    document.querySelectorAll(`.claps[data-id="${id}"] span`).forEach(span => {
      span.textContent = post.claps;
    });
    
    // animation
    el.classList.add("animated");
    setTimeout(() => el.classList.remove("animated"), 400);
    const float = document.createElement("div");
    float.className = "clap-float";
    float.textContent = "üëè";
    el.appendChild(float);
    setTimeout(() => float.remove(), 600);
    
    // üî• notify other tabs/pages to sync
    window.dispatchEvent(new StorageEvent("storage", {
      key: "posts",
      newValue: JSON.stringify(posts)
    }));
  }
});

// ==========================
// Search filter
// ==========================
function setupSearch(posts) {
  const searchInput = document.getElementById("search");
  if (!searchInput) return;

  searchInput.addEventListener("input", e => {
    const q = e.target.value.toLowerCase();
    const filtered = posts.filter(p =>
      p.title.toLowerCase().includes(q) ||
      p.excerpt.toLowerCase().includes(q) ||
      p.tags.join(" ").toLowerCase().includes(q)
    );
    displayPosts(filtered);
  });
}

// ==========================
// Render single post view
// ==========================
async function loadSinglePost() {
  const params = new URLSearchParams(window.location.search);
  const file = params.get("file");
  if (!file) return;

  const res = await fetch("posts.json");
  const posts = await res.json();
  const saved = loadSavedPosts();
  if (saved) {
    posts.forEach(p => {
      const match = saved.find(sp => sp.file === p.file);
      if (match && typeof match.claps === "number") {
        p.claps = match.claps;
      }
    });
  }

  const post = posts.find(p => p.file === file);
  if (!post) {
    document.getElementById("post-container").innerHTML = "<p>Post not found.</p>";
    return;
  }

  document.getElementById("post-title").textContent = post.title;
  document.getElementById("post-date").textContent = post.date;
  document.getElementById("post-read").textContent = post.readTime;
  document.getElementById("post-tags").innerHTML = post.tags.map(t => `<span class="tag">${t}</span>`).join("");
  const clapEl = document.getElementById("post-claps");
  clapEl.dataset.id = post.file;
  clapEl.querySelector("span").textContent = post.claps;

  const mdRes = await fetch(post.file);
  const mdText = await mdRes.text();

  if (window.marked) {
    document.getElementById("post-content").innerHTML = marked.parse(mdText);
  } else {
    document.getElementById("post-content").textContent = mdText;
  }

  savePosts(posts);
}

// ==========================
// Page bootstrap
// ==========================
if (document.getElementById("posts-container")) {
  loadPosts();
}
if (document.getElementById("post-container")) {
  loadSinglePost();
}
</script>
  <br><br><br>
  <footer>¬© 2025 Patrick Clement. All rights reserved.</footer>
</body>
</html>
